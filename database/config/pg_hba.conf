# ============================================================================
# GUAIR.APP - POSTGRESQL HOST-BASED AUTHENTICATION (HBA)
# ============================================================================
# Descripción: Configuración de autenticación y acceso para PostgreSQL
#              con compliance PCI-DSS
# Compliance: PCI-DSS 2.2.4, 8.2, 8.3
# ============================================================================

# FORMATO:
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# ============================================================================
# IMPORTANTE - PCI-DSS REQUIREMENTS
# ============================================================================
# PCI-DSS 2.2.4: Configurar parámetros de seguridad del sistema
# PCI-DSS 8.2.1: Autenticación de usuarios con credenciales únicas
# PCI-DSS 8.3.1: MFA para acceso administrativo remoto
# ============================================================================

# ============================================================================
# LOCAL CONNECTIONS (desde el mismo servidor)
# ============================================================================

# Usuario postgres (superuser) - solo desde socket local con peer authentication
# PCI-DSS: Acceso de superuser solo desde consola del servidor
local   all             postgres                                peer

# Resto de usuarios locales - requiere password scram-sha-256
# PCI-DSS 8.2.3: Passwords deben ser encriptados en tránsito y almacenamiento
local   all             all                                     scram-sha-256

# ============================================================================
# IPv4 LOCAL CONNECTIONS
# ============================================================================

# Localhost (127.0.0.1) - desarrollo local
# Usar scram-sha-256 para autenticación segura
host    all             all             127.0.0.1/32            scram-sha-256

# ============================================================================
# IPv6 LOCAL CONNECTIONS
# ============================================================================

# Localhost IPv6 (::1)
host    all             all             ::1/128                 scram-sha-256

# ============================================================================
# REMOTE CONNECTIONS - PRODUCCIÓN
# ============================================================================

# IMPORTANTE: Ajustar estas IPs según la infraestructura real

# Application servers (Next.js backend)
# Reemplazar 10.0.1.0/24 con la subnet real de los servidores de aplicación
# PCI-DSS: Solo permitir conexiones desde servidores autorizados
# host    guaira_db       guaira_app      10.0.1.0/24             scram-sha-256

# IP específica del servidor de aplicación
# Reemplazar con IP real del servidor Next.js
# host    guaira_db       guaira_app      10.0.1.100/32           scram-sha-256

# Read replica / Backup server
# Reemplazar con IP del servidor de réplica
# host    replication     replicator      10.0.2.50/32            scram-sha-256

# ============================================================================
# ADMIN ACCESS - PCI-DSS 8.3
# ============================================================================

# Acceso administrativo - solo desde IPs autorizadas
# PCI-DSS: Implementar MFA para acceso administrativo remoto
# Considerar usar certificados SSL en lugar de solo password

# Admin desde bastion host / jump server
# Reemplazar con IP del bastion host
# hostssl all             postgres        10.0.0.10/32            cert clientcert=verify-full

# DBA workstations (requiere SSL + certificado)
# hostssl all             dba_role        10.0.3.0/24             cert clientcert=verify-full

# ============================================================================
# MONITORING & BACKUP TOOLS
# ============================================================================

# Servidor de monitoring (Prometheus, Grafana, etc.)
# host    postgres        monitoring      10.0.4.20/32            scram-sha-256

# Servidor de backups (pg_dump, WAL archiving)
# host    all             backup_user     10.0.4.30/32            scram-sha-256

# ============================================================================
# DESARROLLO (SOLO EN ENTORNO NO-PRODUCCIÓN)
# ============================================================================

# ADVERTENCIA: Nunca habilitar esto en producción
# Descomentar solo para desarrollo local

# Permitir desde cualquier IP (SOLO DESARROLLO)
# host    all             all             0.0.0.0/0               scram-sha-256

# ============================================================================
# REPLICATION
# ============================================================================

# Replicación streaming (para high availability)
# hostssl replication     replicator      10.0.2.0/24             scram-sha-256

# ============================================================================
# DENY ALL OTHERS (default deny)
# ============================================================================

# Por seguridad, denegar cualquier conexión no especificada arriba
# Esta línea es implícita, pero la incluimos explícitamente para claridad

# ============================================================================
# CONFIGURACIÓN RECOMENDADA PARA GUAIR.APP EN PRODUCCIÓN
# ============================================================================

# Ejemplo de configuración completa para producción:

# 1. Local postgres user (consola del servidor)
# local   all             postgres                                peer

# 2. Usuarios de aplicación locales
# local   guaira_db       guaira_app                              scram-sha-256

# 3. Servidor de aplicación (Next.js)
# hostssl guaira_db       guaira_app      64.23.201.2/32          scram-sha-256
# hostssl guaira_db       guaira_app      [IP_APP_SERVER]/32      scram-sha-256

# 4. Acceso de backup
# hostssl all             backup_user     [IP_BACKUP_SERVER]/32   scram-sha-256

# 5. Replicación (si aplica)
# hostssl replication     replicator      [IP_REPLICA]/32         scram-sha-256

# 6. Monitoring
# host    postgres        monitoring      [IP_MONITORING]/32      scram-sha-256

# ============================================================================
# NOTAS DE SEGURIDAD - PCI-DSS
# ============================================================================

# 1. SIEMPRE usar 'hostssl' en lugar de 'host' para conexiones remotas
#    PCI-DSS 4.1: Encriptar transmisión de datos de tarjetahabientes

# 2. NUNCA usar 'trust' authentication en producción
#    PCI-DSS 8.2: Autenticación de usuarios obligatoria

# 3. Preferir 'scram-sha-256' sobre 'md5'
#    PCI-DSS 8.2.3: Passwords deben estar protegidos criptográficamente

# 4. Limitar conexiones a IPs específicas (no usar 0.0.0.0/0)
#    PCI-DSS 1.3: Restringir acceso directo entre Internet y sistema

# 5. Considerar certificados SSL cliente para admins
#    PCI-DSS 8.3: MFA para acceso administrativo

# 6. Rotar passwords regularmente
#    PCI-DSS 8.2.4: Cambiar passwords cada 90 días

# 7. Logs de autenticación
#    PCI-DSS 10.2.4: Loggear intentos de acceso exitosos y fallidos
#    Ver postgresql.conf: log_connections = on

# ============================================================================
# TESTING DE CONFIGURACIÓN
# ============================================================================

# Para probar esta configuración sin reiniciar PostgreSQL:
# sudo -u postgres pg_ctl reload -D /var/lib/postgresql/16/main

# Para verificar desde el cliente:
# psql "host=64.23.201.2 dbname=guaira_db user=guaira_app sslmode=require"

# Para ver intentos de conexión:
# sudo tail -f /var/log/postgresql/postgresql-16-main.log | grep connection

# ============================================================================
# MANTENIMIENTO
# ============================================================================

# Después de cambiar este archivo:

# 1. Validar sintaxis (no hay validador built-in, revisar manualmente)

# 2. Reload configuración:
#    sudo systemctl reload postgresql@16-main

# 3. Verificar logs:
#    sudo tail -f /var/log/postgresql/postgresql-16-main.log

# 4. Probar conexión desde cada origen permitido

# 5. Verificar que conexiones no autorizadas son rechazadas

# ============================================================================
# FIN DE CONFIGURACIÓN HBA
# ============================================================================

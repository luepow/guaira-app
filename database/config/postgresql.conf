# ============================================================================
# GUAIR.APP - POSTGRESQL 16 CONFIGURATION FOR PRODUCTION
# ============================================================================
# Descripción: Configuración optimizada para PostgreSQL 16 en producción
#              con compliance PCI-DSS y optimización para alta concurrencia
# Servidor: 64.23.201.2
# RAM: 8GB (ajustar según servidor real)
# CPU: 4 cores (ajustar según servidor real)
# Disco: SSD
# Compliance: PCI-DSS Level 1
# ============================================================================

# ============================================================================
# FILE LOCATIONS
# ============================================================================
# Estas rutas deben ajustarse según la instalación real de PostgreSQL

# data_directory = '/var/lib/postgresql/16/main'
# hba_file = '/etc/postgresql/16/main/pg_hba.conf'
# ident_file = '/etc/postgresql/16/main/pg_ident.conf'

# ============================================================================
# CONNECTIONS AND AUTHENTICATION
# ============================================================================

# Máximo de conexiones concurrentes
# Para aplicación web con pool de conexiones, 200 es razonable
max_connections = 200

# Superuser reservado connections
superuser_reserved_connections = 3

# ============================================================================
# MEMORY SETTINGS (ajustar según RAM disponible)
# ============================================================================
# Asumiendo 8GB RAM total, 4GB dedicados a PostgreSQL

# Memoria compartida (25% de RAM dedicada)
# PCI-DSS: Buffer pool debe ser suficiente para hot data
shared_buffers = 2GB

# Memoria de trabajo por operación (sort, hash join)
# Fórmula: (RAM * 0.25) / max_connections
work_mem = 10MB

# Memoria para operaciones de mantenimiento (VACUUM, CREATE INDEX)
maintenance_work_mem = 512MB

# Effective cache size (50-75% de RAM total del sistema)
# PostgreSQL lo usa para estimar cuánto cachea el SO
effective_cache_size = 6GB

# Shared memory para autovacuum
autovacuum_work_mem = 256MB

# ============================================================================
# WRITE AHEAD LOG (WAL) - CRITICAL FOR PCI-DSS
# ============================================================================
# PCI-DSS 10.5.3: Proteger logs de auditoría contra alteraciones

# WAL level para replicación y PITR (Point-In-Time Recovery)
wal_level = replica

# Fsync para garantizar durabilidad (NUNCA desactivar en producción)
fsync = on

# Método de sync (fdatasync es más rápido que fsync en Linux)
wal_sync_method = fdatasync

# Tamaño de segmentos WAL (16MB default, aumentar para high write workload)
wal_segment_size = 16MB

# Número mínimo de archivos WAL a mantener
min_wal_size = 1GB
max_wal_size = 4GB

# Checkpoints (ajustar para balance entre recovery time y write performance)
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# WAL buffers (3% de shared_buffers o 16MB, lo que sea mayor)
wal_buffers = 16MB

# Compression de WAL (PostgreSQL 14+)
wal_compression = on

# ============================================================================
# REPLICATION (si se implementa High Availability)
# ============================================================================

# Número de WAL senders para replication
max_wal_senders = 5

# Slots de replicación
max_replication_slots = 5

# Keep WAL segments
wal_keep_size = 1GB

# Hot standby (para read replicas)
hot_standby = on
hot_standby_feedback = on

# Replication timeout
wal_sender_timeout = 60s
wal_receiver_timeout = 60s

# ============================================================================
# QUERY PLANNING
# ============================================================================

# Random page cost (1.1 para SSD, 4.0 para HDD)
random_page_cost = 1.1

# Sequential page cost
seq_page_cost = 1.0

# CPU costs
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# Parallel query settings
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0

# Default statistics target (100 es el default, aumentar para mejor planning)
default_statistics_target = 100

# ============================================================================
# AUTOVACUUM - CRITICAL FOR PERFORMANCE
# ============================================================================
# PCI-DSS: Mantener performance óptimo para auditoría y compliance

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# Thresholds para vacuum automático
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_vacuum_insert_threshold = 1000

# Thresholds para analyze
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# Vacuum cost delay (ajustar para evitar impacto en producción)
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# Freeze para prevenir transaction ID wraparound
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000

# ============================================================================
# LOGGING - PCI-DSS REQUIREMENT 10
# ============================================================================
# PCI-DSS 10.2: Implementar audit trails para todos los accesos a datos

# Log destination
logging_collector = on
log_destination = 'stderr'

# Directorio de logs
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Rotación de logs
log_rotation_age = 1d
log_rotation_size = 100MB
log_file_mode = 0600
log_truncate_on_rotation = off

# Qué loggear - PCI-DSS compliance
log_connections = on
log_disconnections = on
log_duration = off
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '

# Log de queries lentas (ajustar threshold según necesidad)
log_min_duration_statement = 1000  # Log queries > 1 segundo

# Log levels
log_min_messages = warning
log_min_error_statement = error

# Log statements (none, ddl, mod, all)
# PCI-DSS: Loggear DDL y modificaciones
log_statement = 'ddl'

# Log locks
log_lock_waits = on
deadlock_timeout = 1s

# Log checkpoints
log_checkpoints = on

# Log autovacuum
log_autovacuum_min_duration = 0

# Log temporary files
log_temp_files = 0

# ============================================================================
# STATISTICS AND MONITORING
# ============================================================================
# PCI-DSS 11.5: Monitoreo de integridad de archivos y alertas

# Shared preload libraries
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.track_planning = on

# Track activity
track_activities = on
track_counts = on
track_io_timing = on
track_wal_io_timing = on
track_functions = all

# Stats temp directory (en RAM para mejor performance)
stats_temp_directory = '/var/run/postgresql/16-main.pg_stat_tmp'

# ============================================================================
# CLIENT CONNECTION DEFAULTS
# ============================================================================

# Timezone (ajustar según ubicación del servidor)
timezone = 'America/Caracas'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Character set
client_encoding = 'UTF8'

# Default transaction isolation
default_transaction_isolation = 'read committed'

# Statement timeout (30 segundos para prevenir queries colgadas)
statement_timeout = 30000

# Idle in transaction timeout (5 minutos)
idle_in_transaction_session_timeout = 300000

# Lock timeout
lock_timeout = 10000

# ============================================================================
# SECURITY - PCI-DSS REQUIREMENTS
# ============================================================================

# SSL/TLS - PCI-DSS 4.1: Encriptar datos en tránsito
ssl = on
ssl_cert_file = '/etc/ssl/certs/ssl-cert-snakeoil.pem'
ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'

# TLS versions permitidas (solo TLS 1.2 y 1.3)
ssl_min_protocol_version = 'TLSv1.2'
ssl_max_protocol_version = 'TLSv1.3'

# Ciphers seguros (ajustar según política de seguridad)
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_prefer_server_ciphers = on

# Password encryption (scram-sha-256 es el más seguro)
password_encryption = scram-sha-256

# Row Level Security
row_security = on

# ============================================================================
# RESOURCE LIMITS
# ============================================================================

# Máximo de archivos abiertos por proceso
max_files_per_process = 1000

# Máximo de locks
max_locks_per_transaction = 64

# Máximo de predicados de locks (para serializable isolation)
max_pred_locks_per_transaction = 64

# ============================================================================
# ERROR HANDLING
# ============================================================================

# Restart after backend crash
restart_after_crash = on

# Exit on error
exit_on_error = off

# ============================================================================
# LOCALE AND FORMATTING
# ============================================================================

datestyle = 'iso, mdy'
intervalstyle = 'postgres'

# ============================================================================
# CUSTOMIZED OPTIONS (Application-specific)
# ============================================================================

# Para la aplicación Guair.app
# Puede establecer parámetros personalizados aquí

# Custom parameters para audit logging
# app.hmac_secret = 'CHANGE_THIS_IN_PRODUCTION'
# app.current_user_id = ''
# app.user_role = ''

# ============================================================================
# EXTENSIONS
# ============================================================================

# Las extensiones se instalan por base de datos, no aquí
# Ver migration 001_pci_dss_extensions.sql

# ============================================================================
# PERFORMANCE TUNING NOTES
# ============================================================================

# IMPORTANTE: Después de cambiar esta configuración:
#
# 1. Validar la configuración:
#    sudo -u postgres /usr/lib/postgresql/16/bin/postgres -D /var/lib/postgresql/16/main -C config_file
#
# 2. Reiniciar PostgreSQL:
#    sudo systemctl restart postgresql@16-main
#
# 3. Verificar logs:
#    sudo tail -f /var/log/postgresql/postgresql-16-main.log
#
# 4. Monitorear performance:
#    SELECT * FROM pg_stat_database;
#    SELECT * FROM pg_stat_user_tables;
#    SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 20;
#
# 5. Ajustar según métricas reales de producción

# ============================================================================
# FIN DE CONFIGURACIÓN
# ============================================================================

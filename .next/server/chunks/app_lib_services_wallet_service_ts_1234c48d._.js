module.exports=[44634,e=>{"use strict";var a=e.i(29173),t=e.i(64855),r=e.i(39179),i=e.i(54799);"function"==typeof setImmediate||"object"==typeof scheduler&&"function"==typeof scheduler.postTask&&scheduler.postTask.bind(scheduler);let n=new a.PrismaClient;class d{static async createWallet(e){let{userId:a,currency:d="USD",initialBalance:s=0}=e;if(!await n.user.findUnique({where:{id:a}}))throw new r.NotFoundError("Usuario");if(await n.wallet.findUnique({where:{userId:a}}))throw new r.ConflictError("El usuario ya tiene una wallet");let l=await n.wallet.create({data:{userId:a,currency:d,balance:s,status:"active"}});return s>0&&await this.createLedgerEntry({transactionId:i.default.randomUUID(),userId:a,walletId:l.id,accountType:"asset",debit:s,credit:0,balance:s,currency:d,description:"Balance inicial"}),await t.AuditService.logCreate("wallet",l.id,l,a),l}static async getWallet(e){let a=await n.wallet.findUnique({where:{id:e},include:{user:{select:{id:!0,name:!0,email:!0,phone:!0}}}});if(!a)throw new r.NotFoundError("Wallet");return a}static async getUserWallet(e){let a=await n.wallet.findUnique({where:{userId:e},include:{user:{select:{id:!0,name:!0,email:!0,phone:!0}}}});if(!a)throw new r.NotFoundError("Wallet");return a}static async deposit(e){let{walletId:a,userId:i,amount:d,currency:s="USD",source:l,sourceId:c,description:o,metadata:w,idempotencyKey:u,ipAddress:p,userAgent:f}=e,h=await n.transaction.findUnique({where:{idempotencyKey:u}});return h||n.$transaction(async e=>{let n=await e.wallet.findUnique({where:{id:a}});if(!n)throw new r.NotFoundError("Wallet");if(n.userId!==i)throw new r.AppError(r.ErrorCodes.FORBIDDEN,"No tienes permiso para realizar esta operación",403);if("active"!==n.status)throw new r.AppError(r.ErrorCodes.WALLET_SUSPENDED,"La wallet está suspendida o cerrada",400);let h=n.balance,E=h+d,y=await e.transaction.create({data:{userId:i,walletId:a,type:"deposit",amount:d,currency:s,status:"succeeded",description:o||`Dep\xf3sito desde ${l}`,metadata:w,idempotencyKey:u,sourceId:c}});return await e.wallet.update({where:{id:a},data:{balance:E}}),await e.ledgerEntry.create({data:{transactionId:y.id,userId:i,walletId:a,accountType:"asset",debit:d,credit:0,balance:E,currency:s,description:`Dep\xf3sito - ${o||l}`,metadata:w}}),await e.ledgerEntry.create({data:{transactionId:y.id,userId:i,walletId:a,accountType:"revenue",debit:0,credit:d,balance:0,currency:s,description:`Ingreso por dep\xf3sito - ${o||l}`,metadata:w}}),await t.AuditService.logWalletOperation(a,i,"deposit",h,E,{ipAddress:p,userAgent:f}),await t.AuditService.logTransaction(y.id,i,"deposit",d,s,"succeeded",{ipAddress:p,userAgent:f}),y})}static async withdraw(e){let{walletId:a,userId:i,amount:d,currency:s="USD",destination:l,destinationId:c,description:o,metadata:w,idempotencyKey:u,ipAddress:p,userAgent:f}=e,h=await n.transaction.findUnique({where:{idempotencyKey:u}});return h||n.$transaction(async e=>{let n=await e.wallet.findUnique({where:{id:a}});if(!n)throw new r.NotFoundError("Wallet");if(n.userId!==i)throw new r.AppError(r.ErrorCodes.FORBIDDEN,"No tienes permiso para realizar esta operación",403);if("active"!==n.status)throw new r.AppError(r.ErrorCodes.WALLET_SUSPENDED,"La wallet está suspendida o cerrada",400);if(n.balance<d)throw new r.InsufficientBalanceError(n.balance,d);let h=n.balance,E=h-d,y=await e.transaction.create({data:{userId:i,walletId:a,type:"withdrawal",amount:d,currency:s,status:"processing",description:o||`Retiro hacia ${l}`,metadata:w,idempotencyKey:u,destinationId:c}});return await e.wallet.update({where:{id:a},data:{balance:E}}),await e.ledgerEntry.create({data:{transactionId:y.id,userId:i,walletId:a,accountType:"expense",debit:d,credit:0,balance:0,currency:s,description:`Gasto por retiro - ${o||l}`,metadata:w}}),await e.ledgerEntry.create({data:{transactionId:y.id,userId:i,walletId:a,accountType:"asset",debit:0,credit:d,balance:E,currency:s,description:`Retiro - ${o||l}`,metadata:w}}),await t.AuditService.logWalletOperation(a,i,"withdrawal",h,E,{ipAddress:p,userAgent:f}),await t.AuditService.logTransaction(y.id,i,"withdrawal",d,s,"processing",{ipAddress:p,userAgent:f}),y})}static async transfer(e){let{fromWalletId:a,fromUserId:i,toUserId:d,amount:s,currency:l="USD",description:c,metadata:o,idempotencyKey:w,ipAddress:u,userAgent:p}=e,f=await n.transaction.findUnique({where:{idempotencyKey:w}});return f||n.$transaction(async e=>{let[n,f]=await Promise.all([e.wallet.findUnique({where:{id:a}}),e.wallet.findUnique({where:{userId:d}})]);if(!n)throw new r.NotFoundError("Wallet origen");if(!f)throw new r.NotFoundError("Wallet destino");if(n.userId!==i)throw new r.AppError(r.ErrorCodes.FORBIDDEN,"No tienes permiso para realizar esta operación",403);if("active"!==n.status||"active"!==f.status)throw new r.AppError(r.ErrorCodes.WALLET_SUSPENDED,"Una de las wallets está suspendida o cerrada",400);if(n.balance<s)throw new r.InsufficientBalanceError(n.balance,s);let h=await e.transaction.create({data:{userId:i,walletId:a,type:"transfer",amount:-s,currency:l,status:"succeeded",description:c||`Transferencia a ${d}`,metadata:o,idempotencyKey:w,destinationId:f.id}});await e.transaction.create({data:{userId:d,walletId:f.id,type:"transfer",amount:s,currency:l,status:"succeeded",description:c||`Transferencia de ${i}`,metadata:o,idempotencyKey:`${w}-receive`,sourceId:n.id}});let E=n.balance-s,y=f.balance+s;return await Promise.all([e.wallet.update({where:{id:a},data:{balance:E}}),e.wallet.update({where:{id:f.id},data:{balance:y}})]),await e.ledgerEntry.createMany({data:[{transactionId:h.id,userId:i,walletId:a,accountType:"asset",debit:0,credit:s,balance:E,currency:l,description:`Transferencia enviada - ${c||""}`},{transactionId:h.id,userId:d,walletId:f.id,accountType:"asset",debit:s,credit:0,balance:y,currency:l,description:`Transferencia recibida - ${c||""}`}]}),await t.AuditService.logWalletOperation(a,i,"transfer_send",n.balance,E,{ipAddress:u,userAgent:p}),await t.AuditService.logWalletOperation(f.id,d,"transfer_receive",f.balance,y,{ipAddress:u,userAgent:p}),h})}static async createLedgerEntry(e){return n.ledgerEntry.create({data:e})}static async getBalance(e){let a=await n.wallet.findUnique({where:{id:e},select:{balance:!0,currency:!0,status:!0}});if(!a)throw new r.NotFoundError("Wallet");return a}static async suspendWallet(e,a,i){let d=await n.wallet.findUnique({where:{id:e}});if(!d)throw new r.NotFoundError("Wallet");let s=await n.wallet.update({where:{id:e},data:{status:"suspended"}});return await t.AuditService.logUpdate("wallet",e,{status:d.status},{status:"suspended"},a,{reason:i}),s}static async activateWallet(e,a){let i=await n.wallet.findUnique({where:{id:e}});if(!i)throw new r.NotFoundError("Wallet");let d=await n.wallet.update({where:{id:e},data:{status:"active"}});return await t.AuditService.logUpdate("wallet",e,{status:i.status},{status:"active"},a),d}}e.s(["WalletService",()=>d],44634)}];

//# sourceMappingURL=app_lib_services_wallet_service_ts_1234c48d._.js.map